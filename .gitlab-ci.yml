image: node:18-alpine

variables:
  FIREBASE_PROJECT_ID: $FIREBASE_PROJECT_ID
  FIREBASE_PROJECT_STAGING_ID: $FIREBASE_PROJECT_STAGING_ID
  FIREBASE_TOKEN: $FIREBASE_TOKEN
  NODE_ENV: production
  HUSKY: 0  # d√©sactive Husky dans tous les jobs CI

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - back/node_modules/
    - front/node_modules/
    - .npm/

stages:
  - install
  - lint
  - test
  - security
  - build
  - deploy-staging
  - deploy-production

before_script:
  - npm install -g firebase-tools --no-audit --no-fund

# --- Install Dependencies ---
install_dependencies:
  stage: install
  script:
    - cd back && npm ci --silent --prefer-offline
    - cd ../front && npm ci --silent --prefer-offline
  artifacts:
    paths:
      - back/node_modules/
      - front/node_modules/
    expire_in: 1h

# --- Lint ---
lint:
  stage: lint
  script:
    - cd back/functions && npx eslint -c .eslintrc.json . --max-warnings=0
    - cd ../../front && npx eslint -c eslint.config.cjs . --ext .js,.jsx,.ts,.tsx --max-warnings=0
  allow_failure: false

# --- Test ---
test:
  stage: test
  script:
    - cd back && npm test -- --coverage --watchAll=false
    - cd ../front && npm run test -- --coverage --watchAll=false
  artifacts:
    paths:
      - back/coverage/
      - front/coverage/
    expire_in: 1w

# --- Security Audit ---
security_audit:
  stage: security
  script:
    - cd back && npm audit --audit-level high || true
    - cd ../front && npm audit --audit-level high || true
  allow_failure: true

# --- Build ---
build:
  stage: build
  script:
    - cd back && npm run build
    - cd ../front && npm run build
  artifacts:
    paths:
      - back/dist/
      - front/dist/
    expire_in: 2h

# --- Deploy Staging ---
deploy_staging:
  stage: deploy-staging
  script:
    - firebase use $FIREBASE_PROJECT_STAGING_ID --token $FIREBASE_TOKEN
    - firebase deploy --token $FIREBASE_TOKEN --project $FIREBASE_PROJECT_STAGING_ID
  environment:
    name: staging
    url: https://$FIREBASE_PROJECT_STAGING_ID.web.app
  only:
    - test
  when: manual

# --- Deploy Production ---
deploy_production:
  stage: deploy-production
  script:
    - firebase use $FIREBASE_PROJECT_ID --token $FIREBASE_TOKEN
    - firebase deploy --token $FIREBASE_TOKEN --project $FIREBASE_PROJECT_ID
  environment:
    name: production
    url: https://$FIREBASE_PROJECT_ID.web.app
  only:
    - main
  when: manual
